apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: external-secrets
  namespace: flux-system
spec:
  chart:
    spec:
      chart: external-secrets
      sourceRef:
        kind: HelmRepository
        name: external-secrets
      version: '>=1.15.0-0'
  install:
    crds: Create
  interval: 5m0s
  releaseName: external-secrets
  upgrade:
    crds: CreateReplace

  values:
    env:
      VAULT_ADDR: https://vault.service.home:8200/
    image:
      repository: godaddy/kubernetes-external-secrets
      tag: 8.0.1

    nodeSelector:
      kubernetes.io/arch: amd64

    affinity:
      nodeAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          nodeSelectorTerms:
            - matchExpressions:
                - key: node-role.kubernetes.io/application
                  operator: In
                  values:
                    - "true"

    serviceMonitor:
      enabled: true
